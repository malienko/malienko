---
import Layout from '../layouts/Layout.astro';
---

<Layout
  title="Marketplace Map - Anton Malienko"
  description="Interactive map of Facebook Marketplace saved items"
>
  <div class="container">
    <h1>Marketplace Map</h1>
    <p>Upload a screenshot of your Facebook Marketplace saved items to visualize them on an interactive map.</p>

    <div class="upload-section">
      <input type="file" id="screenshot-upload" accept="image/*" />
      <button id="process-btn" class="btn">Process Screenshot</button>
    </div>

    <div id="map-container">
      <div id="map"></div>
    </div>

    <div id="items-list"></div>
  </div>
</Layout>

<style>
  .upload-section {
    margin: 2rem 0;
    padding: 2rem;
    border: 2px dashed #ccc;
    border-radius: 8px;
    text-align: center;
  }

  #screenshot-upload {
    margin-bottom: 1rem;
  }

  .btn {
    background-color: #0066cc;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
  }

  .btn:hover {
    background-color: #0052a3;
  }

  .btn:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  #map-container {
    margin: 2rem 0;
    display: none;
  }

  #map {
    height: 600px;
    width: 100%;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  #items-list {
    margin-top: 2rem;
  }

  .item-card {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .item-card img {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 4px;
  }

  .item-info {
    flex: 1;
  }

  .item-name {
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .item-price {
    color: #0066cc;
    font-weight: 600;
  }

  .item-location {
    color: #666;
    font-size: 0.9rem;
  }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script is:inline>
  // @ts-nocheck
  let map = null;
  let markers = [];

  // Sample data structure for marketplace items
  // In real implementation, this would come from image processing
  const sampleItems = [
    {
      id: 1,
      name: "Office Chair",
      price: "$150",
      location: "Montreal, QC",
      lat: 45.5017,
      lng: -73.5673,
      image: "https://github.com/user-attachments/assets/6c0a5858-5ac6-438a-9b72-b6cb2ba8a930"
    },
    {
      id: 2,
      name: "Gaming PC",
      price: "$800",
      location: "Laval, QC",
      lat: 45.6066,
      lng: -73.7124,
      image: "https://github.com/user-attachments/assets/c1a9f0b8-5ac6-438a-9b72-b6cb2ba8a931"
    },
    {
      id: 3,
      name: "Table Legs",
      price: "$50",
      location: "Longueuil, QC",
      lat: 45.5312,
      lng: -73.5185,
      image: "https://github.com/user-attachments/assets/d1a9f0b8-5ac6-438a-9b72-b6cb2ba8a932"
    }
  ];

  function initMap() {
    // Initialize map centered on Montreal
    map = window.L.map('map').setView([45.5017, -73.5673], 11);

    window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(map);
  }

  function addMarker(item) {
    if (!map) return;

    // Create custom icon
    const icon = window.L.divIcon({
      className: 'custom-marker',
      html: `<div class="marker-pin"></div>`,
      iconSize: [30, 30],
      iconAnchor: [15, 30]
    });

    const marker = window.L.marker([item.lat, item.lng], { icon })
      .addTo(map)
      .bindTooltip(`
        <div style="text-align: center;">
          <img src="${item.image}" alt="${item.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-bottom: 0.25rem; display: block;">
          <strong style="font-size: 0.9rem;">${item.name}</strong><br>
          <span style="color: #0066cc; font-weight: 600;">${item.price}</span>
        </div>
      `, {
        direction: 'top',
        offset: [0, -20],
        className: 'custom-tooltip'
      })
      .bindPopup(`
        <div class="marker-popup">
          <img src="${item.image}" alt="${item.name}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px; margin-bottom: 0.5rem;">
          <div style="font-weight: 700;">${item.name}</div>
          <div style="color: #0066cc; font-weight: 600;">${item.price}</div>
          <div style="color: #666; font-size: 0.9rem;">${item.location}</div>
        </div>
      `, {
        autoPan: false
      });

    markers.push(marker);
    return marker;
  }

  function displayItems(items) {
    const itemsList = document.getElementById('items-list');
    if (!itemsList) return;

    itemsList.innerHTML = '<h2>Items List</h2>';

    items.forEach(item => {
      const card = document.createElement('div');
      card.className = 'item-card';
      card.innerHTML = `
        <img src="${item.image}" alt="${item.name}">
        <div class="item-info">
          <div class="item-name">${item.name}</div>
          <div class="item-price">${item.price}</div>
          <div class="item-location">${item.location}</div>
        </div>
      `;

      card.addEventListener('click', () => {
        if (!map) return;

        const marker = markers.find(m =>
          m.getLatLng().lat === item.lat &&
          m.getLatLng().lng === item.lng
        );
        if (marker) {
          map.setView([item.lat, item.lng], 14);
          marker.openPopup();
        }
      });

      itemsList.appendChild(card);
    });
  }

  function loadSampleData() {
    // Clear existing markers
    markers.forEach(m => m.remove());
    markers = [];

    // Add markers for sample items
    sampleItems.forEach(item => {
      addMarker(item);
    });

    // Display items list
    displayItems(sampleItems);

    // Show map
    const mapContainer = document.getElementById('map-container');
    if (mapContainer) {
      mapContainer.style.display = 'block';
    }

    // Fix map size after container is shown
    if (map) {
      // Small delay to ensure container is fully rendered
      setTimeout(() => {
        map.invalidateSize();

        // Fit bounds to show all markers
        if (markers.length > 0) {
          const group = window.L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.1));
        }
      }, 100);
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    const uploadInput = document.getElementById('screenshot-upload');
    const processBtn = document.getElementById('process-btn');

    if (!uploadInput || !processBtn) return;

    processBtn.addEventListener('click', () => {
      const file = uploadInput.files?.[0];

      if (!file) {
        alert('Please select a screenshot first');
        return;
      }

      // Initialize map if not already done
      if (!map) {
        initMap();
      }

      // For now, load sample data
      // In production, this would process the uploaded image
      processBtn.textContent = 'Processing...';
      processBtn.disabled = true;

      setTimeout(() => {
        loadSampleData();
        processBtn.textContent = 'Process Screenshot';
        processBtn.disabled = false;
      }, 1000);
    });

    // Allow loading sample data without upload for demo
    const demoBtn = document.createElement('button');
    demoBtn.className = 'btn';
    demoBtn.textContent = 'Load Demo Data';
    demoBtn.style.marginLeft = '1rem';
    demoBtn.addEventListener('click', () => {
      if (!map) {
        initMap();
      }
      loadSampleData();
    });

    const uploadSection = document.querySelector('.upload-section');
    if (uploadSection) {
      uploadSection.appendChild(demoBtn);
    }
  });
</script>

<style is:global>
  .custom-marker {
    background: none;
    border: none;
  }

  .marker-pin {
    width: 30px;
    height: 30px;
    border-radius: 50% 50% 50% 0;
    background: #0066cc;
    position: absolute;
    transform: rotate(-45deg);
    left: 50%;
    top: 50%;
    margin: -15px 0 0 -15px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
  }

  .marker-pin::after {
    content: '';
    width: 14px;
    height: 14px;
    margin: 8px 0 0 8px;
    background: #fff;
    position: absolute;
    border-radius: 50%;
  }

  .marker-popup {
    min-width: 150px;
  }

  .leaflet-popup-content-wrapper {
    border-radius: 8px;
  }

  .custom-tooltip {
    background: white;
    border: 2px solid #0066cc;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  }

  .custom-tooltip .leaflet-tooltip-left::before {
    border-left-color: #0066cc;
  }

  .custom-tooltip .leaflet-tooltip-right::before {
    border-right-color: #0066cc;
  }

  .custom-tooltip .leaflet-tooltip-top::before {
    border-top-color: #0066cc;
  }

  .custom-tooltip .leaflet-tooltip-bottom::before {
    border-bottom-color: #0066cc;
  }
</style>
